<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head') %>
<body>
    <%- include('../partials/header') %>
    <%- include('../partials/navbar') %>

    <main class="container" style="padding: 40px 20px; max-width: 900px; margin: 0 auto;">
        <!-- Page Header -->
        <div style="margin-bottom: 40px; text-align: center;">
            <h2 style="color: var(--primary-blue); font-size: 2.2em; margin-bottom: 10px;">Report an Issue</h2>
            <p style="color: #666; font-size: 1.1em;">We're here to help. Submit your complaint and we'll prioritize resolution.</p>
        </div>

        <!-- Support Info Bar -->
        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
            <div style="text-align: center;">
                <div style="font-size: 1.5em; margin-bottom: 5px;">ğŸ“</div>
                <strong style="display: block; color: var(--primary-blue);">24/7 Support</strong>
                <small>Call: 1800-WATER-101</small>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.5em; margin-bottom: 5px;">âš¡</div>
                <strong style="display: block; color: var(--primary-blue);">Quick Response</strong>
                <small>Avg 2 min response time</small>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.5em; margin-bottom: 5px;">âœ“</div>
                <strong style="display: block; color: var(--primary-blue);">Real-time Tracking</strong>
                <small>Monitor your complaint status</small>
            </div>
        </div>

        <!-- Main Form Section -->
        <div class="content-box" style="background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.08);">
            <form id="complaintForm">
                <!-- Personal Information -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary-blue); margin-bottom: 15px; font-size: 1.1em;">ğŸ“‹ Your Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Consumer Number *</label>
                            <input name="consumerNumber" type="text" placeholder="e.g., WS123456" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Phone Number *</label>
                            <input name="phone" type="tel" placeholder="e.g., 98765-43210" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                        </div>
                    </div>
                </div>

                <!-- Issue Details -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary-blue); margin-bottom: 15px; font-size: 1.1em;">âš ï¸ Issue Details</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Issue Type *</label>
                        <select name="issueType" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                            <option value="">-- Select Issue Type --</option>
                            <option value="no-water">âŒ No Water Supply</option>
                            <option value="low-pressure">ğŸ“‰ Low Pressure</option>
                            <option value="contaminated">ğŸš« Contaminated Water</option>
                            <option value="leakage">ğŸ’§ Pipeline Leakage</option>
                            <option value="billing">ğŸ’° Billing Issue</option>
                            <option value="meter">ğŸ“Š Meter Problem</option>
                            <option value="other">ğŸ“ Other</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Severity Level *</label>
                        <select name="severity" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                            <option value="">-- Select Severity --</option>
                            <option value="low">ğŸŸ¢ Low - Can Wait</option>
                            <option value="medium">ğŸŸ¡ Medium - Urgent</option>
                            <option value="high">ğŸ”´ High - Critical</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Description *</label>
                        <textarea name="description" rows="5" placeholder="Please describe your issue in detail. Include location, when it started, and any photos/evidence if available." required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Additional Options -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary-blue); margin-bottom: 15px; font-size: 1.1em;">ğŸ“¸ Attachments (Optional)</h3>
                    <div id="dropZone" style="border: 2px dashed #2196F3; padding: 40px 20px; border-radius: 6px; text-align: center; cursor: pointer; background: #f5f5f5; transition: all 0.3s ease;">
                        <div style="font-size: 2em; margin-bottom: 10px;">ğŸ“·</div>
                        <p style="margin: 0 0 5px 0; color: #333; font-weight: 600;">Click to upload or drag and drop</p>
                        <small style="color: #999;">JPG, PNG, PDF up to 5MB each (Max 5 files)</small>
                        <input id="fileInput" type="file" multiple accept=".jpg,.jpeg,.png,.pdf" style="display: none;">
                    </div>
                    
                    <!-- File List -->
                    <div id="fileList" style="margin-top: 15px; display: none;">
                        <h4 style="color: var(--primary-blue); margin-top: 0; margin-bottom: 10px;">Selected Files:</h4>
                        <div id="fileItems" style="display: grid; gap: 8px;"></div>
                    </div>
                </div>

                <!-- Consent & Submit -->
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input id="consentCheckbox" type="checkbox" required style="width: 18px; height: 18px;">
                        <span>I authorize the municipality to contact me regarding this complaint</span>
                    </label>
                </div>

                <button type="button" onclick="submitComplaint()" style="width: 100%; padding: 14px; background: var(--primary-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: background 0.3s;">Register Complaint</button>
            </form>
        </div>

        <!-- Recent Complaints Info -->
        <div style="margin-top: 40px; padding: 20px; background: #f9f9f9; border-left: 4px solid var(--primary-blue); border-radius: 6px;">
            <h4 style="margin-top: 0; color: var(--primary-blue);">âœ“ What Happens Next?</h4>
            <ol style="margin: 15px 0; padding-left: 20px; line-height: 1.8;">
                <li>Your complaint is registered with a unique Reference ID</li>
                <li>Our team reviews and prioritizes based on severity</li>
                <li>You receive instant SMS/Email confirmation</li>
                <li>Real-time status updates on your complaint page</li>
                <li>Direct communication with assigned technician</li>
            </ol>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script>
        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const fileList = document.getElementById('fileList');
        const fileItems = document.getElementById('fileItems');
        let selectedFiles = [];

        const MAX_FILES = 5;
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

        // Click to upload
        dropZone.addEventListener('click', () => fileInput.click());

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.background = '#e3f2fd';
            dropZone.style.borderColor = '#1976d2';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.background = '#f5f5f5';
            dropZone.style.borderColor = '#2196F3';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = '#f5f5f5';
            dropZone.style.borderColor = '#2196F3';
            handleFiles(e.dataTransfer.files);
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Handle file selection
        function handleFiles(files) {
            const newFiles = Array.from(files);

            // Validate files
            for (let file of newFiles) {
                // Check file size
                if (file.size > MAX_FILE_SIZE) {
                    alert(`File "${file.name}" exceeds 5MB limit`);
                    continue;
                }

                // Check file type
                const validTypes = ['image/jpeg', 'image/png', 'application/pdf'];
                if (!validTypes.includes(file.type)) {
                    alert(`File "${file.name}" has unsupported type. Use JPG, PNG, or PDF`);
                    continue;
                }

                // Check max files
                if (selectedFiles.length >= MAX_FILES) {
                    alert(`Maximum ${MAX_FILES} files allowed`);
                    break;
                }

                selectedFiles.push(file);
            }

            updateFileList();
        }

        // Update file list display
        function updateFileList() {
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                fileItems.innerHTML = '';
                return;
            }

            fileList.style.display = 'block';
            fileItems.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileSize = (file.size / 1024).toFixed(2); // KB
                const fileIcon = file.type === 'application/pdf' ? 'ğŸ“„' : 'ğŸ–¼ï¸';
                
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border: 1px solid #eee; border-radius: 6px; font-size: 0.95em;';
                div.innerHTML = `
                    <span>
                        <span style="margin-right: 8px;">${fileIcon}</span>
                        <strong style="color: #333;">${escapeFileName(file.name)}</strong>
                        <span style="color: #999; margin-left: 8px;">(${fileSize} KB)</span>
                    </span>
                    <button type="button" onclick="removeFile(${index})" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Remove</button>
                `;
                fileItems.appendChild(div);
            });
        }

        // Remove file
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            // Reset file input
            fileInput.value = '';
        }

        // Escape filename for safe HTML display
        function escapeFileName(name) {
            if (name.length > 30) {
                return name.substring(0, 27) + '...';
            }
            return name;
        }

        // Submit complaint with files
        async function submitComplaint() {
            const form = document.getElementById('complaintForm');
            if (!form.checkValidity()) {
                alert('Please fill all required fields marked with *');
                return;
            }

            const consent = document.getElementById('consentCheckbox').checked;
            if (!consent) {
                alert('Please authorize the municipality to contact you');
                return;
            }

            const submitBtn = document.querySelector('button[onclick="submitComplaint()"]');
            const originalText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = 'â³ Submitting...';

            try {
                // Prepare form data with files
                const formData = new FormData();
                formData.append('consumerNumber', form.consumerNumber.value || '');
                formData.append('phone', form.phone.value || '');
                formData.append('issueType', form.issueType.value);
                formData.append('severity', form.severity.value);
                formData.append('description', form.description.value);

                // Add files
                selectedFiles.forEach((file, index) => {
                    formData.append(`attachment_${index}`, file);
                });
                formData.append('attachmentCount', selectedFiles.length);

                // Submit
                const res = await fetch('/citizen/complaint/submit', {
                    method: 'POST',
                    body: formData
                });

                const json = await res.json();

                if (res.ok && json.ok) {
                    alert(`âœ“ Complaint Registered Successfully!\n\nReference ID: ${json.reference}\n\nYou will receive updates via SMS and Email.`);
                    
                    // Reset form and files
                    form.reset();
                    selectedFiles = [];
                    updateFileList();
                    fileInput.value = '';
                    
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalText;
                } else {
                    alert(json.error || 'Failed to register complaint');
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalText;
                }
            } catch (err) {
                console.error(err);
                alert('Server error, please try again later.');
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        }
    </script>
</body>
</html>