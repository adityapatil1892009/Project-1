<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head') %>
<body>
    <%- include('../partials/header') %>
    
    <div style="display: flex; min-height: 100vh; background: #f8f9fa;">
        <!-- Sidebar -->
        <aside style="width: 250px; background: var(--dark-blue); color: white; padding: 30px 20px; overflow-y: auto;">
            <h2 style="margin: 0 0 30px 0; font-size: 1.5rem; font-weight: 700;">Admin Panel</h2>
            
            <nav style="display: flex; flex-direction: column; gap: 10px;">
                <button onclick="switchTab('dashboard')" class="nav-btn active" style="padding: 12px 16px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 8px; cursor: pointer; text-align: left; font-weight: 600; transition: all 0.3s;">
                    üìä Dashboard
                </button>
                <button onclick="switchTab('users')" class="nav-btn" style="padding: 12px 16px; background: transparent; border: none; color: white; border-radius: 8px; cursor: pointer; text-align: left; font-weight: 600; transition: all 0.3s;">
                    üë• User Management
                </button>
                <button onclick="switchTab('schedule')" class="nav-btn" style="padding: 12px 16px; background: transparent; border: none; color: white; border-radius: 8px; cursor: pointer; text-align: left; font-weight: 600; transition: all 0.3s;">
                    üìÖ Schedule Editor
                </button>
                <button onclick="switchTab('settings')" class="nav-btn" style="padding: 12px 16px; background: transparent; border: none; color: white; border-radius: 8px; cursor: pointer; text-align: left; font-weight: 600; transition: all 0.3s;">
                    ‚öôÔ∏è Settings
                </button>
                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 20px 0;">
                <a href="/logout" style="padding: 12px 16px; background: rgba(239,68,68,0.2); border: none; color: white; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 600; display: block; text-decoration: none; transition: all 0.3s;">
                    üö™ Logout
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main style="flex: 1; padding: 40px; overflow-y: auto;">
            <% if (error) { %>
                <div style="background: rgba(239,68,68,0.1); border-left: 4px solid #ef4444; padding: 16px; border-radius: 8px; color: #dc2626; margin-bottom: 20px;">
                    ‚ö†Ô∏è <%= error %>
                </div>
            <% } %>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content" style="display: block;">
                <h1 style="color: var(--dark-blue); margin-bottom: 30px;">Dashboard</h1>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
                    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">Total Users</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary-blue);"><%= totalUsers %></div>
                    </div>
                    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">Page Visits</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #22c55e;">15,234</div>
                    </div>
                    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">System Status</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">‚úÖ Online</div>
                    </div>
                </div>

                <div id="stats-container" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin-top: 0;">Statistics</h3>
                    <p style="color: #888;">Loading...</p>
                </div>
            </div>

            <!-- User Management Tab -->
            <div id="users-tab" class="tab-content" style="display: none;">
                <h1 style="color: var(--dark-blue); margin-bottom: 30px;">User Management</h1>
                
                <button onclick="showAddUserForm()" style="background: var(--primary-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 20px;">
                    ‚ûï Add New User
                </button>

                <div id="add-user-form" style="display: none; background: white; padding: 24px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin-top: 0;">Add New User</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <input type="text" id="newUserName" placeholder="Full Name" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <input type="email" id="newUserEmail" placeholder="Email" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <select id="newUserRole" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option>citizen</option>
                            <option>authority</option>
                        </select>
                        <input type="text" id="newUserCode" placeholder="Area Code" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button onclick="addNewUser()" style="background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Save User
                        </button>
                        <button onclick="hideAddUserForm()" style="background: #ddd; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>

                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <table id="users-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 1px solid #ddd;">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Name</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Email</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Role</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Area Code</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.forEach((user, idx) => { %>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px;"><%= user.name %></td>
                                    <td style="padding: 12px;"><%= user.email %></td>
                                    <td style="padding: 12px;"><span style="background: <%= user.role === 'admin' ? 'rgba(168,85,247,0.2)' : user.role === 'authority' ? 'rgba(59,130,246,0.2)' : 'rgba(34,197,94,0.2)' %>; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600;"><%= user.role %></span></td>
                                    <td style="padding: 12px;"><%= user.areaCode || '-' %></td>
                                    <td style="padding: 12px; text-align: center;">
                                        <button onclick="editUser(<%= idx %>)" style="background: none; border: none; color: var(--primary-blue); cursor: pointer; font-weight: 600; margin-right: 10px;">Edit</button>
                                        <button onclick="deleteUser(<%= idx %>)" style="background: none; border: none; color: #ef4444; cursor: pointer; font-weight: 600;">Delete</button>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Schedule Editor Tab -->
            <div id="schedule-tab" class="tab-content" style="display: none;">
                <h1 style="color: var(--dark-blue); margin-bottom: 30px;">Schedule Editor</h1>
                
                <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div id="schedule-select" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Select Area:</label>
                        <select id="areaSelect" onchange="loadScheduleArea()" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; max-width: 300px;">
                            <option>Choose an area...</option>
                            <% Object.keys(schedule).forEach(area => { %>
                                <option value="<%= area %>"><%= area %></option>
                            <% }); %>
                        </select>
                    </div>

                    <div id="schedule-form" style="display: none;">
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Area Name:</label>
                                <input type="text" id="schedAreaName" disabled style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; background: #f5f5f5;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Zone:</label>
                                <input type="text" id="schedZone" placeholder="e.g., Zone A" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Status:</label>
                                <select id="schedStatus" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                                    <option>Active</option>
                                    <option>Scheduled</option>
                                    <option>Interrupted</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Timing (e.g., 6:00 AM - 8:00 AM):</label>
                                <input type="text" id="schedTiming" placeholder="6:00 AM - 8:00 AM" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Duration:</label>
                                <input type="text" id="schedDuration" placeholder="2 hours" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Message (optional):</label>
                                <textarea id="schedMessage" placeholder="Service interruption message..." style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; min-height: 80px;"></textarea>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="saveSchedule()" style="background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    üíæ Save Changes
                                </button>
                                <button onclick="resetScheduleForm()" style="background: #ddd; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content" style="display: none;">
                <h1 style="color: var(--dark-blue); margin-bottom: 30px;">Settings</h1>
                
                <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin-top: 0;">Translation Settings</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Enable Languages:</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="langEn" checked style="width: 18px; height: 18px;">
                                <span>English</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="langHi" checked style="width: 18px; height: 18px;">
                                <span>Hindi</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="langMr" checked style="width: 18px; height: 18px;">
                                <span>Marathi</span>
                            </label>
                        </div>
                    </div>

                    <button onclick="saveSettings()" style="background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        üíæ Save Settings
                    </button>
                </div>
            </div>
        </main>
    </div>

    <%- include('../partials/footer') %>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.style.background = 'transparent');
            event.target.style.background = 'rgba(255,255,255,0.2)';

            // Load data for specific tabs
            if (tabName === 'users') loadAllUsers();
            if (tabName === 'dashboard') loadStats();
        }

        // USER MANAGEMENT
        function showAddUserForm() {
            document.getElementById('add-user-form').style.display = 'block';
        }

        function hideAddUserForm() {
            document.getElementById('add-user-form').style.display = 'none';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserCode').value = '';
        }

        async function addNewUser() {
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const role = document.getElementById('newUserRole').value;
            const areaCode = document.getElementById('newUserCode').value;

            if (!name || !email) {
                alert('Name and Email are required');
                return;
            }

            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, role, areaCode })
            });

            const result = await response.json();
            if (result.ok) {
                hideAddUserForm();
                loadAllUsers();
                alert('User added successfully!');
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function loadAllUsers() {
            const response = await fetch('/api/admin/users');
            const users = await response.json();
            
            let html = '<thead><tr style="background: #f8f9fa; border-bottom: 1px solid #ddd;"><th style="padding: 12px; text-align: left; font-weight: 600;">Name</th><th style="padding: 12px; text-align: left; font-weight: 600;">Email</th><th style="padding: 12px; text-align: left; font-weight: 600;">Role</th><th style="padding: 12px; text-align: left; font-weight: 600;">Area Code</th><th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th></tr></thead><tbody>';
            
            users.forEach((user, idx) => {
                html += `<tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px;">${user.name}</td>
                    <td style="padding: 12px;">${user.email}</td>
                    <td style="padding: 12px;"><span style="background: ${user.role === 'admin' ? 'rgba(168,85,247,0.2)' : user.role === 'authority' ? 'rgba(59,130,246,0.2)' : 'rgba(34,197,94,0.2)'}; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">${user.role}</span></td>
                    <td style="padding: 12px;">${user.areaCode || '-'}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="editUser(${idx})" style="background: none; border: none; color: var(--primary-blue); cursor: pointer; font-weight: 600; margin-right: 10px;">Edit</button>
                        <button onclick="deleteUser(${idx})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-weight: 600;">Delete</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody>';
            document.getElementById('users-table').innerHTML = html;
        }

        function editUser(idx) {
            alert('Edit functionality coming soon!');
        }

        async function deleteUser(idx) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            const response = await fetch(`/api/admin/users/${idx}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.ok) {
                loadAllUsers();
                alert('User deleted!');
            }
        }

        // SCHEDULE MANAGEMENT
        const scheduleData = <%- JSON.stringify(schedule) %>;

        function loadScheduleArea() {
            const area = document.getElementById('areaSelect').value;
            if (!area || !scheduleData[area]) {
                document.getElementById('schedule-form').style.display = 'none';
                return;
            }

            const data = scheduleData[area];
            document.getElementById('schedAreaName').value = area;
            document.getElementById('schedZone').value = data.zone || '';
            document.getElementById('schedStatus').value = data.status || 'Active';
            document.getElementById('schedTiming').value = data.timing || '';
            document.getElementById('schedDuration').value = data.duration || '';
            document.getElementById('schedMessage').value = data.message || '';
            
            document.getElementById('schedule-form').style.display = 'block';
        }

        async function saveSchedule() {
            const area = document.getElementById('areaSelect').value;
            const zone = document.getElementById('schedZone').value;
            const status = document.getElementById('schedStatus').value;
            const timing = document.getElementById('schedTiming').value;
            const duration = document.getElementById('schedDuration').value;
            const message = document.getElementById('schedMessage').value;

            const response = await fetch(`/api/admin/schedule/${area}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ zone, status, timing, duration, message })
            });

            const result = await response.json();
            if (result.ok) {
                alert('Schedule updated successfully!');
            } else {
                alert('Error: ' + result.error);
            }
        }

        function resetScheduleForm() {
            loadScheduleArea();
        }

        // STATISTICS
        async function loadStats() {
            const response = await fetch('/api/admin/stats');
            const stats = await response.json();

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; border-left: 4px solid var(--primary-blue);">
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 6px;">Total Users</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--primary-blue);">${stats.totalUsers}</div>
                    </div>
                    <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border-left: 4px solid #22c55e;">
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 6px;">Total Citizens</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #22c55e;">${stats.totalCitizens}</div>
                    </div>
                    <div style="background: #eff6ff; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 6px;">Authority Users</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #3b82f6;">${stats.totalAuthority}</div>
                    </div>
                    <div style="background: #faf5ff; padding: 16px; border-radius: 8px; border-left: 4px solid #a855f7;">
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 6px;">Contact Messages</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #a855f7;">${stats.totalContacts}</div>
                    </div>
                    <div style="background: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 6px;">Maintenance Requests</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #f59e0b;">${stats.totalMaintenanceRequests}</div>
                    </div>
                    <div style="background: #fce7f3; padding: 16px; border-radius: 8px; border-left: 4px solid #ec4899;">
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 6px;">Notices Published</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #ec4899;">${stats.totalNotices}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('stats-container').innerHTML = html;
        }

        // SETTINGS
        async function saveSettings() {
            const enabledLanguages = [];
            if (document.getElementById('langEn').checked) enabledLanguages.push('en');
            if (document.getElementById('langHi').checked) enabledLanguages.push('hi');
            if (document.getElementById('langMr').checked) enabledLanguages.push('mr');

            const response = await fetch('/api/admin/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabledLanguages, defaultLanguage: 'en' })
            });

            const result = await response.json();
            if (result.ok) {
                alert('Settings saved successfully!');
            }
        }

        // Load stats on page load
        window.addEventListener('DOMContentLoaded', loadStats);
    </script>

    <style>
        .nav-btn:hover {
            background: rgba(255,255,255,0.15) !important;
        }
    </style>
</body>
</html>
